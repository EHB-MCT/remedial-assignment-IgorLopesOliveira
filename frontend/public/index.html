<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Market & Inventory</title>
  <link rel="stylesheet" href="index.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js CDN -->
</head>
<body>
  <!-- Wallet & Inventory controls remain the same -->
  <div id="controls-container">
    <div id="wallet-container">
      <button id="wallet-button">üí∞ Balance: ‚Ç¨100</button>
      <div id="wallet-dropdown" class="hidden">
        <p><strong>Balance:</strong> ‚Ç¨<span id="wallet-balance">100</span></p>
        <p><strong>Transaction History:</strong></p>
        <ul id="transaction-list"></ul>
        <div id="balance-graph">
          <p style="text-align:center; padding-top: 80px; color: #999;">(Balance Graph Coming Soon)</p>
        </div>
      </div>
    </div>
    <div id="inventory-container">
      <button class="inventory-toggle" onclick="toggleInventory()">üóÉÔ∏è Inventory</button>
      <div id="inventory-list-wrapper" style="display: none;">
        <ul id="inventory-list"></ul>
      </div>
    </div>
  </div>

  <h1>üåç Market Resources</h1>
  <div class="product-grid" id="productGrid"></div>

<script>
const USER_ID = 'USER123';

// Fetch and display products
fetch('http://localhost:8080/api/products')
  .then(res => res.json())
  .then(data => {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = '';
    data.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product card';
      card.innerHTML = `
        <div class="card-inner">
          <div class="card-front">
            <img src="images/${product.image}" alt="${product.name}" class="product-img" style="width:100%;cursor:pointer;" />
            <h3>${product.name}</h3>
            <p>${product.description}</p>
            <p class="price">üí∞ $${product.price}</p>
            <p class="qty">üì¶ ${product.quantity} in stock</p>
            <div class="buy-controls">
              <input type="number" min="1" max="${product.quantity}" value="1" id="qty-${product._id}" />
              <button onclick="buyProduct('${product._id}')">üõí Buy</button>
            </div>
          </div>
          <div class="card-back" id="back-${product._id}">
            <p>Click image to see price history</p>
          </div>
        </div>
      `;
      // Add click listener to flip & load graph
      card.querySelector('img').addEventListener('click', () => showPriceHistory(product._id, card));
      grid.appendChild(card);
    });
  });

// Function to fetch and display price history in card back
function showPriceHistory(productId, card) {
  // Toggle flip state
  card.classList.toggle('flipped');
  
  // If card is now flipped (showing back), load the chart
  if (card.classList.contains('flipped')) {
    const back = document.getElementById(`back-${productId}`);
    back.innerHTML = `<p>Loading price history...</p>`;

    fetch(`http://localhost:8080/api/market/price-history/${productId}`)
      .then(res => res.json())
      .then(history => {
        if (!history.hasHistory) {
          back.innerHTML = `<p>No price changes recorded yet.</p>`;
          return;
        }
        // Create canvas for chart
        back.innerHTML = `<canvas id="chart-${productId}"></canvas>`;
        const ctx = document.getElementById(`chart-${productId}`).getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: history.data.map(h => new Date(h.timestamp).toLocaleDateString()),
            datasets: [{
              label: 'Price',
              data: history.data.map(h => h.price),
              borderColor: 'blue',
              fill: false,
              tension: 0.2
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { x: { display: true }, y: { display: true } }
          }
        });
      })
      .catch(err => {
        console.error('‚ùå Price history fetch error:', err);
        back.innerHTML = `<p>Error loading price history.</p>`;
      });
  }
}

// Wallet & Inventory functions remain unchanged
function loadWallet() {
  fetch(`http://localhost:8080/api/users/${USER_ID}/wallet`)
    .then(res => res.json())
    .then(data => {
      walletBtn.innerHTML = `üí∞ Balance: ‚Ç¨${data.balance}`;
      walletBalanceSpan.textContent = data.balance;
      transactionList.innerHTML = '';
      data.transactionHistory.slice().reverse().forEach((entry) => {
        const li = document.createElement('li');
        li.textContent = `${entry.type.toUpperCase()}: ${entry.product} (${entry.type === 'buy' ? '-' : '+'}‚Ç¨${entry.total})`;
        transactionList.appendChild(li);
      });
    });
}

function loadInventory() {
  fetch(`http://localhost:8080/api/users/${USER_ID}/inventory`)
    .then(res => res.json())
    .then(data => {
      const inventoryList = document.getElementById('inventory-list');
      inventoryList.innerHTML = '';
      data.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${item.product.name} - Qty: ${item.quantity}
          <button onclick="sellProduct('${item.product._id}', 1)">Sell 1</button>
        `;
        inventoryList.appendChild(li);
      });
    });
}

function buyProduct(productId) {
  const qtyInput = document.getElementById(`qty-${productId}`);
  const quantity = parseInt(qtyInput.value) || 1;

  fetch(`http://localhost:8080/api/market/buy/${productId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: USER_ID, quantity })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('Purchase successful!');
      loadWallet();
      loadInventory();
      // Refresh the product grid to update quantities
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  });
}

function sellProduct(productId, quantity) {
  fetch(`http://localhost:8080/api/market/sell/${productId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: USER_ID, quantity })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.success ? 'Sold!' : data.error);
    loadWallet();
    loadInventory();
    // Refresh the product grid to update quantities
    location.reload();
  });
}

const walletBtn = document.getElementById('wallet-button');
const walletDropdown = document.getElementById('wallet-dropdown');
const walletBalanceSpan = document.getElementById('wallet-balance');
const transactionList = document.getElementById('transaction-list');

walletBtn.addEventListener('click', () => {
  if (walletDropdown.classList.contains('show')) {
    walletDropdown.classList.remove('show');
    walletDropdown.classList.add('hidden');
  } else {
    walletDropdown.classList.remove('hidden');
    walletDropdown.classList.add('show');
  }
});

function toggleInventory() {
  const wrapper = document.getElementById('inventory-list-wrapper');
  wrapper.style.display = wrapper.style.display === 'block' ? 'none' : 'block';
}

// Initial load
loadWallet();
loadInventory();
</script>
</body>
</html>